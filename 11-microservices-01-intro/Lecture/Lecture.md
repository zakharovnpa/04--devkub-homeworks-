## Лекция по теме "Введение в микросервисы"

Михаил
ТриполитовМихаил Триполитов
Technical Lead
Михаил Триполитов

### 2План занятия
1. Микросервисы
2. Преимущества
3. Сопутствующие проблемы
4. Антипаттерны
5. Сложные решения
6. Когда не стоит использовать?
7. Итоги
8. Домашнее задание

### 3Микросервисы

### 4Что такое микросервисы?
Микросервисы — это архитектурный подход разделения системы
на небольшие автономные сервисы, которые запускаются как
отдельные процессы и взаимодействуют, используя API на основе
легких протоколов, например, HTTP. И обладают определенными характеристиками
Если сервисы обладают определенными характеристиками, то можно сказать что система основана на микросервисах.

- 00:04:30 - Есть некоторые характеристики системы, кторые позволяют назвать ее микросервисом.

- 00:05:00 Характреистики:
  - легкая поддержка и тестирование каждого сервиса отдельно
  - сервисы между собой должны быть слабо связаны
  - должно быть независимое развертывание каждого сервиса
  - сервисы не должны зависеть от других сервисов (например от версий)
  - можно запустить отдельный микросервис в отделном, например контейнере и при этом никакн е повлиять на всю систему.

- 00:06:00 - важнейший аспект микросервисов - они ориентируются вокруг бизнес функционала и относятся к определенному бизнес-процессу
- у каждого сервиса должен быть владелец (например команда разработчиков) тогда можно будет быстрее доставлять результаты работы прграммистов до продакшн, а значит и для пользователей

- 00:07:15 - Вывод: микросервисная архитектура способствует частой, быстрой и надежной поставке крупных и сложных приложений. 
При этом позволяя организации развивать свой технологичесикй стек за счет этой самой назависимости


### 5Что такое микросервисы?      - 00:07:35
Монолитное приложение содержит все бизнес-функции в одном
процессе.


### 6Что такое микросервисы?
Микросервисы распределяют бизнес-функции по разным
независимым сервисам. И запущенным в разных процессах

- 00:08:40 - важный аспект - коммуникация между микросервисами и между потребителями
  - это дает четкое разделение зон ответсвенности и границы различных команд (разработчиков) заставляя их 
  более четко и осмысленно подходить к задаче проектррования своего сервиса, своего API и того как эти сервисы буду  коммуницировать друг с другом. Надо выбрать протокол взаимодействия микросервисов.
  способы безопасности взаимодействия и т.д.
  

### 7Характеристики микросервисов     - 00:09:40
- Слабая связность → команда (разработчиков) работает независимо от изменений в других сервисах.
  - Должна обеспечиваться обратная совместимость контрактов. Если меняется версия какого-либо сервиса, то другие сервисы не должны менять све поведение и способы взаимодействия
- Независимы при выкладке → нет необходимости координировать выкладку с другими командами
- Поддерживаемость и тестируемость → быстрая разработка и частые выкладки
  - Это позволяет делать маленькие изменения в коде, но частые. 
  - Позволяет тестировать быстро и ожидать что ничего не сломается при выкладке на прод
- Наличие кросс функциональной команды-владельца → сокращает расходы на коммуникации
- Организация вокруг бизнес функций → глубокое понимание домена (группа отвечающая за определенный функционал)

### 8Размер     - 00:15:50
Объединяйте вместе функциональность, изменяющуюся по одной
причине, разделяйте функциональность, изменяющуюся по разным
причинам. Это принцип единой ответственности.
Чем меньше сервисы, тем больше влияние преимуществ и
негативных последствий микросервисной архитектуры.
→
Чем меньше сервисы, тем более они независимы друг от друга, но
выше общая сложность системы.

- Слишком много маленьких микросервисов также плохо как один большой монолит
- 00:17:10 - пример

### 9Зачем использовать     - 00:20:10
Микросервисы повышают скорость, увеличивают частоту и
надежность внесения изменений в крупные ИТ системы при
часто меняющихся бизнес требованиях.
Обладает преимуществами при построении следующих систем:
- с большим количеством интеграций
- с часто меняющейся неоднородной нагрузкой
- обеспечивающие работу различных бизнес подразделений

Микросервисы - это инструмент для крупных компаний, которые позволяют повысить скорость, частоту и надежность внесения изменений в крупные бизнес-системы, особенно при часто меняющихся бизнес-требованиях
Преимущества этог оподхода хорошо проявляется при построении системы с большим кол-вом интеграций, с часто меняющейся неоднородной нагрузкой.
Это для тех компаний, которые хотят быстрее реагировать на то, что происходит на рынке

### 10Преимущества      - 00:21:30
### 11Преимущества
- Возможность использовать разные технологии
- Устойчивость к ошибкам
- Масштабируемость
- Простота развертывания
- Простота замены
- Отражение структуры организации

### 12Разные технологии
Java
Graph DB
Python
Go
Relational DB
NodeJS
.Net
Blob storage
![mikroservise-1](./Files/mikroservise-1.png)

### 13Устойчивость к ошибкам
Техники работы с ошибками:
- Таймаут → не занимать лишние ресурсы
- Прерыватель цепи → снизить нагрузку на сервисы, испытывающие проблемы
- Повтор → получить ответ, не смотря на сетевые проблемы
- Идемпотентность → исключить бизнес ошибки при повторах
- Переборка → снизить влияние разного функционала друг на друга
- Изоляция → снизить зависимость от других сервисов
- Распределение нагрузки → обеспечить ресурсами критичные процессы
- Балансировка → исключить единую точку отказа

### 14Масштабируемость
Сервисы распределяются между серверами в зависимости от потребностей
Server 1
Server 2
Server N

### 15Простота развертывания
- Небольшие изменения
- Частые выкладки
- Низкие риски
- Независимость

### 16Простота замены
.Net Core
NodeJS
Full
rewrite

### 17Отражение структуры организации
«Организации проектируют системы,
которые копируют структуру коммуникаций
в этой организации»
Закон Конвея

### 18Сопутствующие проблемы

### 19Проблемы разработки
- Совместимость API
- Версионирование артефактов
- Автоматизация сборки и тестирования
- Документация
- Инфраструктура разработки
- 
### 20Проблемы эксплуатации
- Мониторинг
- Сбор логов
- Управление настройками
- Управление инфраструктурой

### 21Антипаттерны

### 22Антипаттерн: серебряная пуля
Нет
Процесс:
Непрерывная поставка
Пытаться решить все проблемы
разработки применением
микросервисов
Да
Микросервисы - архитектурный
стиль, который может помочь
повысить скорость, частоту и
надежность релизов
Позволяет
Позволяет
Разработка
системы
Организация:
Небольшие,
независимые
кросс-
функциональные
команды
Архитектура:
микросервисы
Позволяет

### 23Антипаттерн: самоцель
Нет
Хорошие метрики
Делать внедрение
микросервисов целью, по
которой измеряется успех
разработки ИТ системы ●
Да ●
Цель - увеличить скорость,
частоту и качество поставки
●
●
Время выкладки - время от
коммита до выкладки
Частота выкладки - количество
выкладок в день на одного
разработчика
Интенсивность отказов - количество
неуспешных выкладок
Время восстановления - время
восстановления после отказа


### 24Антипаттерн: наносервисы
Нет
Создавать большое количество очень маленьких сервисов
Да
Один сервис на команду

### 25Сложные решения

### 26Как разделять систему на сервисы?
Low coupling and high cohesion:
● Небольшое количество внешних связей
● Решает близкие по смыслу задачи
Предметно-ориентированное проектирование:
Ограниченный контекст → сервис

### 27Кто владелец сервиса?
Общий код - любой разработчик может изменить любой
сервис и выложить его
По командам - только команда-владелец сервиса может
изменить сервис и выложить
Общий код, но есть владелец сервиса - любой разработчик
может изменить любой сервис, но выложить можно только по
согласованию с владельцем сервиса

### 28Взаимодействие синхронное или асинхронное?
Синхронное (Request/Response) Асинхронное (Event-based)
Да - простота понимания Да - устойчивость к пиковым нагрузкам
Да - простота отладки и реализации Да - балансировка нагрузки за счет
брокеров очередей
Нет - балансировка производительности
Да - слабая связность системы
Нет - риск каскадных отказов
Нет - система балансировка нагрузки
Нет - организация Service Discovery
Нет - общая высокая сложность системы
Нет - запросы на чтение требуют
дополнительных посредников

### 29Оркестрация
или хореография?
Service A
1. Do A
Оркестрация
Coordinator
Service B
2. Do B
Отдельный координатор
управляет сервисами указывая
какие операции выполнять в
какой момент времени.
Service C
3. Do C
Хореография
В процессе выполнения операции
каждый сервис публикует
события, которые запускают
операции в других сервисах.
Service B
2. B Done
Service A
1. A Done
Service C

### 30Протоколы интеграции?
● REST - производительный, масштабируемый, простой
● Grpc - легкий, эффективный
● GraphQL - адаптивный, эффективный, гибкий
● JSON-RPC - легкий, понятный

### 31Подход к безопасности
● No authentication - доверять всем запросам внутри периметра
● HTTP(S) Basic Authentication - передавать логин и пароль в
заголовках запроса
● Aouth2 и OpenID Connect - использовать SSO для межсервисного
взаимодействия
● Client Certiﬁcates and mutual TLS - каждому сервису выпускать свой
клиентский сертификат
● HMAC over HTTP - подписывать каждый HTTP запрос секретным
ключем
● API Keys - каждому сервису выпускать API ключ по которому
определять его права

### 32Когда не стоит
использовать?

### 33Когда не стоит использовать?
● Незнакомая предметная область - чем меньше вы
понимаете предметную область, тем сложнее найти
границы контекстов
● Не определена структура организации - разделение на
сервисы не принесет выгоды, если не будет
соответствовать разделению на команды.
● Система с чистого листа - гораздо легче делить
существующую систему на микросервисы, чем пытаться
разделить на сервисы то, чего нет.

### 34Итоги
● Узнали, что такое микросервисы и чем они отличаются
от монолитной системы
● Узнали, какие основные преимущества микросервисов
● Узнали о сложностях, с которыми придётся столкнуться
и о решениях, которые придётся принять
● Разобрали ситуации, когда не стоит использовать
микросервисы
35Домашнее задание
Давайте посмотрим ваше домашнее задание.
● Вопросы по домашней работе задавайте в чате мессенджера Slack.
● Задачи можно сдавать по частям.
● Зачёт по домашней работе проставляется после того, как приняты
все задачи.
36Задавайте вопросы и
пишите отзыв о лекции!
Михаил Триполитов
Михаил Триполитов
