## Лекция по теме "Введение в микросервисы"

Михаил
ТриполитовМихаил Триполитов
Technical Lead
Михаил Триполитов

### 2План занятия
1. Микросервисы
2. Преимущества
3. Сопутствующие проблемы
4. Антипаттерны
5. Сложные решения
6. Когда не стоит использовать?
7. Итоги
8. Домашнее задание

### 3Микросервисы

### 4Что такое микросервисы?
Микросервисы — это архитектурный подход разделения системы
на небольшие автономные сервисы, которые запускаются как
отдельные процессы и взаимодействуют, используя API на основе
легких протоколов, например, HTTP. И обладают определенными характеристиками
Если сервисы обладают определенными характеристиками, то можно сказать что система основана на микросервисах.

* Для каждого микросервиса написан hellm chart
* werf хорошо помогает в сборке

- 01:20:00 - про протоколы. SAOP - RPC протокол основаный на XML. REST - подход к проектированию легких интерфейсов без состояний на основе адресов ресурсов, которые позволяют реализовывать протокол взяимодействия на базе команд HTTP

[Richardson Maturity Model](https://martinfowler.com/articles/richardsonMaturityModel.html)

- 00:04:30 - Есть некоторые характеристики системы, кторые позволяют назвать ее микросервисом.

- 00:05:00 Характреистики:
  - легкая поддержка и тестирование каждого сервиса отдельно
  - сервисы между собой должны быть слабо связаны
  - должно быть независимое развертывание каждого сервиса
  - сервисы не должны зависеть от других сервисов (например от версий)
  - можно запустить отдельный микросервис в отделном, например контейнере и при этом никакн е повлиять на всю систему.

- 00:06:00 - важнейший аспект микросервисов - они ориентируются вокруг бизнес функционала и относятся к определенному бизнес-процессу
- у каждого сервиса должен быть владелец (например команда разработчиков) тогда можно будет быстрее доставлять результаты работы прграммистов до продакшн, а значит и для пользователей

- 00:07:15 - Вывод: микросервисная архитектура способствует частой, быстрой и надежной поставке крупных и сложных приложений. 
При этом позволяя организации развивать свой технологичесикй стек за счет этой самой назависимости


### 5Что такое микросервисы?      - 00:07:35
Монолитное приложение содержит все бизнес-функции в одном
процессе.


### 6Что такое микросервисы?
Микросервисы распределяют бизнес-функции по разным
независимым сервисам. И запущенным в разных процессах

- 00:08:40 - важный аспект - коммуникация между микросервисами и между потребителями
  - это дает четкое разделение зон ответсвенности и границы различных команд (разработчиков) заставляя их 
  более четко и осмысленно подходить к задаче проектррования своего сервиса, своего API и того как эти сервисы буду  коммуницировать друг с другом. Надо выбрать протокол взаимодействия микросервисов.
  способы безопасности взаимодействия и т.д.
  

### 7Характеристики микросервисов     - 00:09:40
- Слабая связность → команда (разработчиков) работает независимо от изменений в других сервисах.
  - Должна обеспечиваться обратная совместимость контрактов. Если меняется версия какого-либо сервиса, то другие сервисы не должны менять све поведение и способы взаимодействия
- Независимы при выкладке → нет необходимости координировать выкладку с другими командами
- Поддерживаемость и тестируемость → быстрая разработка и частые выкладки
  - Это позволяет делать маленькие изменения в коде, но частые. 
  - Позволяет тестировать быстро и ожидать что ничего не сломается при выкладке на прод
- Наличие кросс функциональной команды-владельца → сокращает расходы на коммуникации
- Организация вокруг бизнес функций → глубокое понимание домена (группа отвечающая за определенный функционал)

### 8Размер     - 00:15:50
Объединяйте вместе функциональность, изменяющуюся по одной
причине, разделяйте функциональность, изменяющуюся по разным
причинам. Это принцип единой ответственности.
Чем меньше сервисы, тем больше влияние преимуществ и
негативных последствий микросервисной архитектуры.
→
Чем меньше сервисы, тем более они независимы друг от друга, но
выше общая сложность системы.

- Слишком много маленьких микросервисов также плохо как один большой монолит
- 00:17:10 - пример

### 9Зачем использовать     - 00:20:10
Микросервисы повышают скорость, увеличивают частоту и
надежность внесения изменений в крупные ИТ системы при
часто меняющихся бизнес требованиях.
Обладает преимуществами при построении следующих систем:
- с большим количеством интеграций
- с часто меняющейся неоднородной нагрузкой
- обеспечивающие работу различных бизнес подразделений

Микросервисы - это инструмент для крупных компаний, которые позволяют повысить скорость, частоту и надежность внесения изменений в крупные бизнес-системы, особенно при часто меняющихся бизнес-требованиях
Преимущества этог оподхода хорошо проявляется при построении системы с большим кол-вом интеграций, с часто меняющейся неоднородной нагрузкой.
Это для тех компаний, которые хотят быстрее реагировать на то, что происходит на рынке

### 10Преимущества      - 00:21:30
### 11Преимущества
- Возможность использовать разные технологии
- Устойчивость к ошибкам
- Масштабируемость
- Простота развертывания
- Простота замены
- Отражение структуры организации

### 12Разные технологии
Java
Graph DB
Python
Go
Relational DB
NodeJS
.Net
Blob storage
![mikroservise-1](/11-microservices-01-intro/Files/mikroservice-1.png)

В случае монолитного приложение оно будет рещать все бизнес-задачи. В случае микросервисов - каждый из них будет решать конкретную бизнес-задачу

### 13Устойчивость к ошибкам       - 00:26:00
Техники работы с ошибками:
- Таймаут → не занимать лишние ресурсы
- Прерыватель цепи → снизить нагрузку на сервисы, испытывающие проблемы
- Повтор → получить ответ, не смотря на сетевые проблемы
- Идемпотентность → исключить бизнес ошибки при повторах
- Переборка → снизить влияние разного функционала друг на друга
- Изоляция → снизить зависимость от других сервисов
- Распределение нагрузки → обеспечить ресурсами критичные процессы
- Балансировка → исключить единую точку отказа

### 14Масштабируемость       - 00:29:49
Сервисы распределяются между серверами в зависимости от потребностей
Server 1
Server 2
Server N
Масштабирование монолитного приложения:
![mikroservise-2](/11-microservices-01-intro/Files/mikroservise-2.png)

В hellm chart мы выставляем нужное кол-во реплик. Кубер их разорачивает и все счастливы


### 15Простота развертывания      - 00:32:40
- Небольшие изменения
- Частые выкладки
- Низкие риски
- Независимость

### 16Простота замены     - 00:33:50
.Net Core
NodeJS
Full
rewrite

- При необходимости сервис можно переписать на другом языке программирования
![mikroservise-3](/11-microservices-01-intro/Files/mikroservice-3.png)



### 17Отражение структуры организации     - 00:35:00
> «Организации проектируют системы, которые копируют структуру коммуникаций в этой организации»
Закон Конвея

### 18Сопутствующие проблемы      - 00:36:30

### 19Проблемы разработки      - 00:36:50
- Совместимость API
- Версионирование артефактов
- Автоматизация сборки и тестирования
- Документация
- Инфраструктура разработки
  - Например шаблоны для быстрой разработки и написания кода
  - Доступные библиотеки для разработчиков
  - Должен быть репозиторий для разработки

### 20Проблемы эксплуатации      - 00:41:40
- Мониторинг
- Сбор логов
- Управление настройками
- Управление инфраструктурой (настройками) сервисов. Больше автоматизации для исключения ручного конфигурирования отдельных сервисов

### 21Антипаттерны

### 22Антипаттерн: серебряная пуля      - 00:53:35

Процесс:
Непрерывная поставка
- Нет

 > Пытаться решить все проблемы
 > разработки применением
 > микросервисов



Да
Микросервисы - архитектурный
стиль, который может помочь
повысить скорость, частоту и
надежность релизов

- Разработка системы
- Организация:
  - Небольшие, независимые кросс- функциональные команды
- Архитектура: микросервисы


![mikroservise-4](/11-microservices-01-intro/Files/mikroservice-4.png)

### 23Антипаттерн: самоцель     - 00:54:25
- Нет
  - Делать внедрение микросервисов целью, по которой измеряется успех разработки ИТ системы
- Да 
  - Цель - увеличить скорость, частоту и качество поставки

- Хорошие метрики
  - Время выкладки - время от коммита до выкладки
- Частота выкладки - 
  - количество выкладок в день на одного разработчика
- Интенсивность отказов 
    - количество неуспешных выкладок
- Время восстановления -
  -  время восстановления после отказа


### 24Антипаттерн: наносервисы      - 00:55:40
- Нет
  - Создавать большое количество очень маленьких сервисов
- Да
  - Один сервис на команду

### 25Сложные решения     - 00:56:40

### 26Как разделять систему на сервисы?

Есть два понятия:
- слабая связанность Low coupling  (изменения в одном сервисе не должны приводить к изменениям в другом сервисе). 
  - Каждый сервис можно выложит не меняя других частей системы. 
  - Обратная совместимость на основе API
  - Асинхронная интеграция на основе событий
- сильное зацепление
  - важно найти границы предмета и области, чтобы близкие по смыслу задачи и поведение группировались в одном месте, но при этом оставалась слабо связанной с другими предметными областями. Об этом говорит Предметно-ориентированное проектирование

Low coupling and high cohesion:
- Небольшое количество внешних связей
- Решает близкие по смыслу задачи

- 00:58:10
Предметно-ориентированное проектирование:
Ограниченный контекст → сервис

### 27Кто владелец сервиса?     - 00:59:00
- Общий код - любой разработчик может изменить любой
сервис и выложить его
- По командам - только команда-владелец сервиса может
изменить сервис и выложить
- Общий код, но есть владелец сервиса - любой разработчик
может изменить любой сервис, но выложить можно только по
согласованию с владельцем сервиса

### 28Взаимодействие синхронное или асинхронное?      - 01:00:30

> Выбор типа межсервисного взаиможействия - это одно из важнейших решений при построении рампределенной системы

- Два основных типа взаимодействия:
  - Синхронное (Request/Response) 
    - Да - простота понимания 
    - Да - простота отладки и реализации 
    - Нет - балансировка производительности
    - Нет - риск каскадных отказов
    - Нет - система балансировка нагрузки
    - Нет - организация Service Discovery
  
  - Асинхронное (Event-based)

    - Да - устойчивость к пиковым нагрузкам
    - Да - балансировка нагрузки за счет брокеров очередей
    - Да - слабая связность системы
    - Нет - общая высокая сложность системы
    - Нет - запросы на чтение требуют дополнительных посредников

### 29Оркестрация или хореография?    - 01:03:00

- Оркестрация
  - Отдельный координатор
управляет сервисами указывая
какие операции выполнять в
какой момент времени.

- Хореография
  - В процессе выполнения операции каждый сервис публикует события, которые запускают операции в других сервисах.
    - Позволяет добиться низкой связности
    - Выполнят свою работу по факту получения события 


![mikroservise-5](/11-microservices-01-intro/Files/mikroservice-5.png)

### 30Протоколы интеграции?     - 01:05:22
> Какие протоколы внутренние для межсервисного взаимодействия
> Какие протоколы для взаимодействия с клиентами

- REST - производительный, масштабируемый, простой
- Grpc - легкий, эффективный
- GraphQL - адаптивный, эффективный, гибкий
- JSON-RPC - легкий, понятный

> В зависимости от типов клиентов системы, выбора способа межсервисного взаимодействия, шаблонов загрузки и использования допустимо выбирать один млм несколько протоколов допустимых для использования в системе.


### 31Подход к безопасности     - 01:06:20
- No authentication - доверять всем запросам внутри периметра
- HTTP(S) Basic Authentication - передавать логин и пароль в заголовках запроса
- Aouth2 и OpenID Connect - использовать SSO для межсервисного взаимодействия
- Client Certiﬁcates and mutual TLS - каждому сервису выпускать свой клиентский сертификат
- HMAC over HTTP - подписывать каждый HTTP запрос секретным ключем
- API Keys - каждому сервису выпускать API ключ по которому определять его права

### 32Когда не стоит использовать?      - 01:08:45

### 33Когда не стоит использовать?       - 01:10:40
- Незнакомая предметная область - чем меньше вы
понимаете предметную область, тем сложнее найти
границы контекстов
- Не определена структура организации - разделение на
сервисы не принесет выгоды, если не будет
соответствовать разделению на команды.
- Система с чистого листа - гораздо легче делить
существующую систему на микросервисы, чем пытаться
разделить на сервисы то, чего нет.

### 34Итоги
- Узнали, что такое микросервисы и чем они отличаются
от монолитной системы
- Узнали, какие основные преимущества микросервисов
- Узнали о сложностях, с которыми придётся столкнуться
и о решениях, которые придётся принять
- Разобрали ситуации, когда не стоит использовать
микросервисы

### 35Домашнее задание      - 01:13:40
Давайте посмотрим ваше домашнее задание.
- Вопросы по домашней работе задавайте в чате мессенджера Slack.
- Задачи можно сдавать по частям.
- Зачёт по домашней работе проставляется после того, как приняты
все задачи.
36Задавайте вопросы и
пишите отзыв о лекции!
Михаил Триполитов
Михаил Триполитов
