## Лекция по теме "Микросервисы: масштабирование"

Михаил
ТриполитовМихаил Триполитов
Technical Lead
Михаил Триполитов

### 2План занятия       - 00:01:05
1. Scale Cube
2. Балансировка
3. Кэширование
4. Автомасштабирование
5. Service Discovery
6. Service Mesh
7. Итоги
8. Домашнее задание

### Хрупкость системы     - 00:01:40
* Распределение приложений по независимым серверам добавляет точки отказа, в которых что-то может пойит не так. 
  * Может быть физ. отказ сервера или его части какой-то
  * Нарушение связи между сервисами
  * Отказ БД или брокера сообщений
  * Ошибка в логик еработы самого сервиса или того фреймворка, на котором он построен
* При проектрировании и разработке систем нужно быть готовым к отказам и разрабатывать сервисы с учетом этих возможных отказов
* В некоторых крупных компаниях применяют подход к тестированию `Haose Monkey`. Это специальная отдельная система, которая случайным образом останавливает случайные сервера,
* разрвыает связи между случайными сервисами (и делает это в продакшене). Тем самым вынуждая разработчиков проектировать севисы с учетом возможных отказов.

### Способы защиты от хрупкости     -00:03:20
* Максимальное время ожидания (Timeout)
* Повтор запроса (Retry)
* Прерыватели цепи (Circuit Breaker)
* Перегородки (Bylkhead)
* Ограничитель кол-в запросов (Rate Limiter)
* Изоляция
* Идемпотентность

### Timeouts         - 00:04:00

Важно внимательно относится к выбору таймаутов для тех или иных операций.
Лучше использовать значения по умолчанию.
Необходимо логировать все ошибки таймаутов для анализа как нам лучше поступить - 
увеличить таймаут или доработать вызываемую сторону для того, чтобы она отвечала быстрее

![scaling_01](/11-microservices-04-scaling/Files/scaling_01.png)

### Повтор (Retry)       -00:06:18
Иногда это самый правильный способ отреагировать на ошибку или таймаут. Если была ошибка в одном экземпляре сервиса, то запрос поавдет на другой экземпляр
и успешно отработает.
Настраивать политику повторов надо аккуратно, чтобы не лопустить лишнюю нагрузку на сервис или систему, которая испытывает затруднения.


![scaling_02](/11-microservices-04-scaling/Files/scaling_02.png)

### Прерыватели цепи (Circuit Breaker)      -00:08:20
Эта техника позволяет обрабатывать ситуации, когда есть ошибка во внешнем сервисе и эта ошибка не должна влиять на поведение вызывающей системы и мы хотим снизить нагрузку на сервисы, испытывабщие проблемы.
* Как это работает:
  * освобождает ресурсы, которые начинают заниматься из-за возникшей ошибки

![scaling_03](/11-microservices-04-scaling/Files/scaling_03.png)

### Перегородки (Bylkhead) -00:12:00

Перегородки предотвращают чрезмероне использование ресурса, обеспечивая общую производительность на достаточном уровне.
Этот подход можно реализовывать по разному. Обычно это выделение ограниченного кол-ва ресурса. Похоже на изоляцию с ограничением CPU, RAM.

![scaling_04](/11-microservices-04-scaling/Files/scaling_04.png)

### Ограничитель кол-в запросов (Rate Limiter) -00:13:25
Ответчает ошибкой в случае превышения порога. Часто применяют облачные сервисы для ограничения потребляемых ресурсов.
Есть привязка к аккаунту для контроля ресерсов на каждого потребителя.
Применяется в локальных системах. Лучше ответить ошибкой, чем полным отказом системы.

![scaling_05](/11-microservices-04-scaling/Files/scaling_05.png)

### Изоляция -00:15:30
Каждому сервису выделяют определенное кол-во ресурсов для исключения превышения их использования.
Сейчас изоляцию реализуют через контейнеры Kubernetis или другие оркестраторы

### Идемпотентность

### Масштабирование  -00:17:45
Работа с ошибками нужна для того, чтобы у нас было много экземпляров разных сервисов и по сути это называется масштабированием.
* Две причины при которых может потребоваться масштабирование:
  * Защита от проблем. В случае отказа одного сервиса - запустить другой экзеипляр сервиса.
  * Выдерживать бОльшую нагрузку. Обрабатывать больше запросов и быстрее.
* Вертикальное масштабирование:
  * Многие процессы могут быть улучшены за счет добавления вычислительных мощностей (CPU, RAM, Video).
  * Это дорого. Один большой сервер может быть дороже, чеи два маленьких с совокупной мощность как у большого сервера
  * К более мощным серверам необходимо адаптировать ПО, что тоже увеличивает фин. затраты.
* Выходом является Горизонтальное маштабирование, когда независимые микросервисы распределяются по разным хостам. Тем самым распределяя нагрузку и риски.


### 3Scale Cube  -00:19:50
Для того, чтобы оценивать возможности масштабирования есть подход "Scale Cube"

### 4Scale Cube
* Ось Z - масштабирование через разделение данных: каждая запущенная копия сервиса отвечает за своё подмножество данных
* Ось Y - масштабирование разделением приложения: функции выделяются в отдельные сервисы и запускают независимо друг от друга
* Ось X - горизонтальное масштабирование: запуск нескольких копий приложения

![scaling_06](/11-microservices-04-scaling/Files/scaling_06.png)

### 5Хрупкость системы

### 6Способы защиты от хрупкости
- Максимальное время ожидания (Timeout)
- Повтор запроса (Retry)
- Прерыватели цепи (Circuit Breaker)
- Перегородки (Bulkhead)
- Ограничитель количества запросов (Rate Limiter)
- Изоляция
- Идемпотентность

### 7Балансировка -00:21:30

### 8Балансировщик нагрузки
Основная функция: распределение входящих запросов
по нескольким серверам
Сервисы
Балансировщик
нагрузки
Входящий
трафик

### 9Балансировка
Дополнительные функции
● Терминация SSL
● Активация резервных серверов
● Ассиметричное распределение
запросов
● Защита от DDOS атак
● Gzip cжатие HTTP
● Проверка работоспособности
● Кэширование HTTP
● Контентно зависимое
распределение запросов
● Аутентификация клиентов
● Фильтрация контента
VLAN
Входящий
трафик
HTTPS
HTTP

### 10Балансировщики
Балансировщики
Облачные балансировщики
● Nginx ● AWS Elastic Load Balancer
● F5 ● Google Cloud Load Balancing
● Kemp ● Azure Load Balancer
● HAProxy ● Yandex Cloud Network Load Balancer
● Envoy

### 11Системы обработки задач
Конкурентные
обработчики
задач
Генераторы
задач
Брокер сообщений

### 12Кэширование

### 13Кэширование
Кэширование - наиболее распространенный способ повышения
производительности
Клиентский кэш
1. Hit:
получить из
кэша
Кэш
1. Hit:
получить из
кэша
2. Miss:
получить
от
сервера
Клиент
Сервер
Кэш
1. Hit:
получить из
кэша
2. Miss:
получить
от
сервера
3. Обновить
кэш
Клиент
Прогретый кэш
Сквозной кэш
Сервер
Кэш
2. Miss:
нет
данных
Клиент
Отдельный
поток
наполнения
кэша
Сервер

### 14Кэш встроен в сервис
Сервисы
Кэш
Балансировщик
нагрузки
Входящий
трафик
Кэш
Кэш

### 15Распределенный кэш
Сервисы
Балансировщик
нагрузки
Входящий
трафик
Распределенный
кэш
Кэш
Кэш
Кэш
Кэш

### 16Прогретый кэш
Сервисы
Запись
в кэш
Очередь
Балансировщик
нагрузки
Входящий
трафик
Cache
Cache
Cache
Чтение
из
кэша
Cache

### 17Кэширующий балансировщик
Сервисы
Балансировщик
нагрузки
Входящий
трафик
Cache

### 18In-Memory Кеш
● Hazelcast
● Redis
● Memchached
● Tarantool

### 19Автомасштабирование

### 20Автоматическое масштабирование
Процесс динамического выделения ресурсов для удовлетворения требований
производительности:
При увеличении нагрузки
выделяются дополнительные ресурсы
для обеспечения соглашения об уровне
обслуживания (SLA)
Минимум 2
При снижении нагрузки
освобождаются ресурсы для
экономии средств
+/- 3 в по необходимости
Запущено 2
Максимум 5

### 21Необходимые компоненты
● Мониторинг приложений и инфраструктуры
● Логика принятия решений
● Управление ресурсами
● Тестирование процедуры автомасштабирования

### 22Подходы
● Динамическое масштабирование на основе метрик
приложения или инфраструктуры:
○ Среднее значение CPU
○ Общее количество запросов
○ Длительность обработки задачи
○ Количество запросов завершившихся ошибкой
● Масштабирование по расписанию
● Предсказательное масштабирование

### 23Автомасштабирование
● Kubernetes Horizontal Pod Autoscaler
● Amazon EC2 Auto Scaling
● Azure Monitor
● Google Compute Engine Autoscaling
● Yandex Cloud Cluster-Autoscaler

### 24Service Discovery

### 25Service Discovery
Настройки
У клиентов в конфигурации IP адреса сервисов с которыми ему
нужно взаимодействовать
DNS
У каждого сервиса есть DNS имя за которым несколько IP
адресов его запущенных экземпляров
Service Registry
Специальное программное обеспечение позволяет сервисам при
старте зарегистрировать адреса запускаемого экземпляра, а
клиентам получить эти адреса по имени

### 26Service Registry
Клиент
Выполнение запросов к
сервисам, за балансировку
отвечает клиент
Сервисы
Запрос адресов
сервисов
Service Registry
Регистрация сервисов
в Service Registry

### 27Service Registry
Балансировщик
нагрузки
Выполнение запросов к сервисам,
за балансировку отвечает
балансировщик нагрузки
Сервисы
Клиент
Запрос адресов
сервисов
Service Registry
Регистрация сервисов
в Service Registry

### 28Service Registry
● Zookeeper
● Consul
● Eureka
● Самодельный

### 29Service Mesh

### 30Задачи Service Mesh
● Гибкость настройки взаимодействия сервисов на уровне
инфраструктуры, управление трафиком, балансировка
● Унифицированный мониторинг большой системы
● Повышение безопасности: отсутствие риска перехвата трафика,
полный контроль над сетью, исключение угроз при работе в
нескольких дата центрах или публичных облаках
● Упрощение реализации сложных шаблонов развертывания
приложений: Blue/Green, Canary, A/B Tesing
● Организация взаимодействия сервисов в мульти кластерной
среде

### 31Принцип работы Service Mesh на примере Istio
Схема с сайта https://istio.io/latest/docs/concepts/what-is-istio

### 32Service Mesh
● Istio
● Linkerd
● Consul Connect
● Kuma
● Maesh
● OpenShift Service Mesh
● AWS App Mesh

### 33Итоги
● Узнали важность непрерывной поставки для микросервисной
архитектуры
● Познакомились со способами развертывания микросервисов
● Узнали про разные виды тестирования и изучили влияние пирамиды
тестирования на результат
● Разобрали разные способы обеспечения аутентификации и авторизации
● Познакомились со способами мониторинга: метрики, логи, трассировка
● Обсудили масштабирование и кэш

### 34Домашнее задание
Давайте посмотрим ваше домашнее задание.
● Вопросы по домашней работе задавайте в чате мессенджера Slack.
● Задачи можно сдавать по частям.
● Зачёт по домашней работе проставляется после того, как приняты
все задачи.

### 35Задавайте вопросы и
пишите отзыв о лекции!
Михаил Триполитов
Михаил ТриполитовClient

### Shard 1
Replica 2
VM 1
Replication
Shard 2
Replication
Shard 3
Replication
Replica 3
VM 2
Replica 1
VM 3
