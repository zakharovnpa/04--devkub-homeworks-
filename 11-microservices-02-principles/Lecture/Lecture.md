## Лекция по теме  "Микросервисы: принципы"

Михаил
ТриполитовМихаил Триполитов
Technical Lead
Михаил Триполитов

### 2План занятия
1. Проектирование системы
2. Разделение на сервисы
3. Взаимодействие между сервисами
4. Двенадцать факторов
5. Итоги
6. Домашнее задание

### 3Проектирование системы

### 4Архитектура
Правила
Принципы
Практики
Ограничения
Детальный план
Подробная документация

### 5Стратегические цели
Бизнес
стратегия
Соотносятся
Технологическая
стратегия

### 6Принципы
Цели
Практики
Принципы

### 7Практики
Цели
Масштабирование
бизнеса
Сокращение
используемого
операторами
программного
обеспечения
Оптимизация
ресурсов и затрат
Принципы
Обеспечивать
согласованные
интерфейсы и потоки
данных
Выбирать решения с
быстрым циклом
обратной связи
Уменьшать
избыточную
сложность, заменяя
дублирующие
системы
Практики
Использовать HTTP для
межсервисных интеграций
Исключать интеграционные
базы данных
Использовать независимые
сервисы
Применять непрерывную
интеграцию и постоянное
развертывание
Использовать мониторинг
для получения состояния
сервисов
Автоматически генерировать
клиентские библиотеки для
всех публикуемых
интерфейсов

### 8Практики: необходимый минимум
● Централизованный мониторинг
● Централизованный сбор логов
● Ограниченный набор допустимых интерфейсов
● Безопасное поведение

### 9Разделение на сервисы

### 10Признаки хорошего сервиса
Loose Coupling
Минимизировать влияние изменений в одном сервисе на
всю систему
High Cohesion
Минимизировать необходимость менять несколько
сервисов при изменении поведения системы

### 11Bounded Context
Предметная область
Ограниченный
контекст
Ограниченный
контекст
Ограниченный
контекст
Ограниченный
контекст
Ограниченный
контекст
Ограниченный
контекст

### 12Bounded Context
Интернет-магазин
Предметная область
Цены
Витрина
Ограниченный контекст
Корзина
Заказы
Склад
Доставка

### 13Один контекст. Один сервис. Одна команда.
Ограниченный контекст - это:
● Отдельная команда
● Отдельный репозиторий
● Отдельная схема базы данных
● Отдельная процедура тестирования
● Отдельная процедура выкладки

### 14Причины уменьшать
● Частота изменений
● Масштабирование
● Независимость
● Сложность

### 15Bounded Context
Использование ограниченных контекстов для разбиения системы
на сервисы позволит обеспечить слабую связность и сильное
зацепление, соблюдая баланс размера сервисов.

### 16Взаимодействие между сервисами

### 17Выбор
Какой протокол выбрать?
●
●
●
●
●
●
●
XML-RPC
JSON-RPC
gRPC
REST
GraphQL
SOAP
...
Что еще выбрать?
●
●
●
●
Синхронно / Асинхронно
Оркестрация / Хореография
RPC / Команды и события
….

### 18Выбор
● Обратная совместимость
● Технологическая независимость
● Забота о потребителях
● Четкий интерфейс

### 19Обратная совместимость
Избегайте обратно несовместимых изменений

### 20Технологическая независимость
Избегайте интеграционных технологий и подходов, которые
привязаны к какой-то конкретной технологической платформе

### 21Забота о потребителях
Стремитесь снизить требования к клиентам и упростить
использование интерфейсов
● Документация
● Простое и понятное API
● Готовые клиентские библиотеки

### 22Четкий интерфейс
Прячьте детали реализации от потребителей интерфейсов.
Избегайте интеграционных подходов и технологий, которые
раскрывают детали внутренней реализации потребителям.

### 23Выбор
● Обратная совместимость
● Технологическая независимость
● Забота о потребителях
● Четкий интерфейс

### 24Общая база данных
Заказы
Детали реализации доступны другим
сервисам
Корзина
Потребители ограничены выбранной
технологией БД
У данных нет единого владельца —
логика по манипуляции данными
распределена по разным сервисам
Доставка
БД Заказы

### 25Синхронное или асинхронное взаимодействие
Клиент
Сервер
Запрос
Запрос
Продолжение
выполнения
программы
Ожидание
ответа
Обработка
ответа
Сервер
Клиент
Ответ
Обработка
ответа
Ответ

### 26Запрос / Ответ или События
Запрос / Ответ Событийная модель
Проще для понимания Уменьшает связность
Синхронное и асинхронное Децентрализация логики
взаимодействие Простота расширения системы
Централизует бизнес логику Общая сложность системы
Увеличивает связность Только асинхронный подход

### 27Оркестрация или Хореография
Корзина
Заказы Корзина Заказы
Доставка Оплата Доставка
Оркестратор
Оплата

### 28Remote Procedure Calls
Детали реализации недоступны другим сервисам
При правильном выборе технологии потребители
не ограничены одним стеком
Простота использования
Расширение моделей возможно только через
добавление полей
Ограниченная поддержка инфраструктурными
инструментами

### 29REST ( REpresentation State Transfer )
Детали реализации недоступны другим сервисам
Потребители не ограничены одним стеком
Простота использования
Хорошая поддержка инфраструктурными инструментами
Текстовый формат данных JSON, XML
Расширение моделей возможно только через добавление
полей
Не всегда возможно описать модель в терминах протокола
HTTP

### 30GraphQL
Детали реализации недоступны другим сервисам
Потребители не ограничены одним стеком
Возможность получить несколько ресурсов одним запросом
Возможность указать необходимые данные
Расширение моделей возможно только через добавление полей
Нет поддержки кэширования со стороны инфраструктуры

### 31Событийная модель
Детали реализации недоступны другим сервисам
Потребители не ограничены одним стеком
Возможность получить несколько ресурсов одним запросом
Низкая общая связность решения
Высокая гибкость и способность к расширению
Потребители ограничены выбранной технологией
Высокая общая сложность системы
Повышенные требования к инфраструктуре

### 32Версионирование: SemVer
MAJOR.MINOR.PATCH
Обратно несовместимые
изменения
Добавлена новая
функциональность,
изменения обратно
совместимы
Исправлены ошибки в
существующей
функциональности

### 33Версионирование: версии эндпоинтов
Client 1
Client 2
V1
Service
Client 1 Client 2
V1 V2
Service
Client 1
Client 2
V2
Service

### 34Версионирование: версии сервисов
Client 1 Client 2
V1 V2
Service
v 1.7.3 Service
v 2.0.3
Prod
DB

### 35API Gateway
API Gateway
Корзина
Web App
Доставка
Mobile App
Оплата
Admin App
Заказы
Авторизация
Аутентификация
Трассировка
Логирование

### 36Backend for frontend
Корзина
Admin App
Web Back
Доставка
Web App
Mobile
Back
Mobile App
Оплата
Warehou
se Back
Warehouse
Заказы

### 37Выводы
● Не используйте интеграцию через общую базу данных
● Начинайте с REST для request/response интеграций
● Хореография предпочтительнее чем оркестрация
● Избегайте обратно несовместимых изменений и
необходимости версионировать эндпоинты

### 38Двенадцать факторов

### 39Двенадцать факторов
Читать тут: https://12factor.net/ru/

### 401-4
I. Кодовая база
Одна кодовая база, отслеживаемая в системе контроля версий, –
множество развёртываний
II. Зависимости
Явно объявляйте и изолируйте зависимости
III. Конфигурация
Сохраняйте конфигурацию в среде выполнения
IV. Сторонние службы (Backing Services)
Считайте сторонние службы (backing services) подключаемыми
ресурсами

### 415-8
V. Сборка, релиз, выполнение
Строго разделяйте стадии сборки и выполнения
VI. Процессы
Запускайте приложение как один или несколько процессов не
сохраняющих внутреннее состояние (stateless)
VII. Привязка портов (Port binding)
Экспортируйте сервисы через привязку портов
VIII. Параллелизм
Масштабируйте приложение с помощью процессов

### 429-12
IX. Утилизируемость (Disposability)
Максимизируйте надёжность с помощью быстрого запуска и
корректного завершения работы
X. Паритет разработки/работы приложения
Держите окружения разработки, промежуточного развёртывания
(staging) и рабочего развёртывания (production) максимально похожими
XI. Журналирование (Logs)
Рассматривайте журнал как поток событий
XII. Задачи администрирования
Выполняйте задачи администрирования/управления с помощью разовых
процессов

### 43Итоги
● Разобрались с вариантами разбиения системы на сервисы
● Узнали какие бывают варианты организации взаимодействия
между сервисами
● Познакомились с принципами создания независимых
приложений

### 44Домашнее задание
Давайте посмотрим ваше домашнее задание.
● Вопросы по домашней работе задавайте в чате мессенджера Slack.
● Задачи можно сдавать по частям.
● Зачёт по домашней работе проставляется после того, как приняты
все задачи.

### 45Задавайте вопросы и
пишите отзыв о лекции!
Михаил Триполитов
Михаил Триполитов
