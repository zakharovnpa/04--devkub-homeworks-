## Лекция по теме "Команды для работы с Kubernetes"

Андрей
Копылов
1Андрей Копылов
TechLead
PremiumBonus
Андрей Копылов

### План занятия
1. Команда kubeadm
2. Команда kubectl
3. Итоги
4. Домашнее задание

### 3Главные команды
- kubeadm — серверная команда для настройки и управления кластером;
- kubectl — команда для управления отдельными ресурсами в рамках неймспейса или кластера.

### 4Команда kubeadm

### 5kubeadm init
Инициализация кластера
Полезные флаги:
* --apiserver-advertise-address — этот адрес будет слушать apiserver;
* --apiserver-bind-port — этот порт будет слушать apiserver;
* --control-plane-endpoint — потребуется для других мастеров;
* --cri-socket — сокет ContainerRuntime, по умолчанию ищет сам;
* --node-name — название ноды;
* --service-cidr — диапазон адресов для Сервисов.
* 
### 6kubeadm join
Служит для подключения к существующему кластеру

Полезные флаги:
* --control-plane — флаг указывает, что эта нода станет мастером;
* --token — токен от мастера для подключения;
* + все прошлые.

### 7kubeadm token

Управление токенами для подключения к кластеру
Полезные команды:
* create — создать новый токен;
* list — просмотр существующих токенов;
* delete — удаление токена.

### 8kubeadm conﬁg
Служит для просмотра конфигов инициализации кластера
Полезные команды:
* print init-defaults — просмотр конфига инициализации;
* images list — получение списка служебных конфигов;
* migrate — обновление конфигурации до новой версии.

### 9kubeadm upgrade
Удобная обёртка для обновления ноды кластера
Полезные команды:
* plan — проверяет доступные обновления;
* apply — применяет обновление на кластер;
* node — обновление отдельной ноды.

### 10kubeadm reset
**Сбрасывает конфиги на сервере до изначальных**
Помогает при ошибках конфигурирования и позволяет
начать всё сначала.

### 11kubeadm version
Просто выводит версию kubeadm в консоль :)
Полезна при установке и обновлении — уточняет версию, с
которой надо обновляться.

### 12Команда kubectl

### 13kubectl get
Получение списка ресурсов определённого типа
Полезные флаги:
* --all-namespaces — выводит ресурс из всех NS;
* --selector — применяется для фильтрации;
* --output — полезно при сохранении ресурса в файл
(например, для бекапа).

### 14kubectl describe
Получение детальной информации об объекте в кластере
Полезные флаги:
* --show-events — можно скрыть список событий.

### 15kubectl exec
ыполнение команды в контейнере отдельного пода
Полезные флаги:
* -с, --container — выбор отдельного контейнера в поде;
* -t, --tty — направляет ввод через терминал;
* -i, --stdin — позволяет направить stdin в контейнер.

### 16kubectl edit
Изменение ресурса напрямую в кластере. Вызовет
системный консольный редактор
Полезные флаги:
* --validate — позволяет отключить проверку конфига.

### 17kubectl logs
Получение логов от ресурса или конкретного контейнера
в поде
Полезные флаги:
* --all-containers — получение логов от всех контейнеров в поде сразу;
* -f, --follow — позволяет следить за логами в реальном времени.

### 18kubectl apply / delete
Создание и удаление ресурсов. Обычно применяются с файлами
Полезные флаги:
* -f — указывается файл с ресурсами для применения;
* --grace-period — можно задать таймаут для действия.

### 19kubectl cordon / uncordon / drain / taint
Манипуляции с нодами. Исключение ноды из планирования,
возврат в планировщик и установка режима обслуживания
Полезные флаги:
* --ignore-daemosets(drain) — игнорирует поды демонов,
позволяя им оставаться и работать на ноде.
* -- taint - добавляет запах, признак кноде, чтобы на нее могли присоединяться конкретные поды, или не присоединяться если у них нет соотв. толеранотности.

### 20kubectl port-forward      -00:21:17
Проксирование трафика до выбранного ресурса
Полезные флаги:
* --address — можно указать, какой адрес должен слушать
локально.

Если kubctl установлен на локальной машине то с помощью этой команды можно сделать прокси до нашего кубернетиса,
который может быть недоступен извне и отправлять запросы с нашему поду.

### 21kubectl label, kubectl annotate      -00:22:33
Управление метками и аннотациями ресурсов
Полезные флаги:
* list — вместо изменения выводит список текущих меток/аннотаций для ресурса.

На основе label можно делать фильтрацию. Можно сделать фильтр моего какого-то ресурса. 
Annotate - это для создания аннотации для ресурса и может использоваться как признак для какого-то действия.

### 22kubectl conﬁg     -00:24:27
Управление локальным конфиг-файлом
Полезные команды:
- current-context — получение текущего кластера/пользователя для команд;
- get-contexts — вывод списка доступных контекстов;
- use-context — изменение текущего контекста на указанный.

Это файл в котором описаны контексты, пользователи, файлы. И этот контекст можно переулючать и выбрать тот контекст который нужен сейчас.

### 23Kubernetes Dashboard      -00:25:30
![commands_01](/12-kubernetes-02-commands/Files/commands_01.png)

Позволяет видеть ресурсы кластера. Но некоторые вещи можно быстрее сделат и посмотреть с kubectl.
Есть другой ресурс - lens/Он ставится на нашу машину и является аналогом дашборда кубера. Там можно переключаться между контекстами.
* k9s - консольная утилита для тех же задач. Он использует UI.

### 24Итоги
Сегодня мы изучили:
- команду kubeadm;
- команду kubectl.
И узнали про:
- kubernetes dashboard.

### Практическая часть лекции   -00:29:05

Подготовка соего ПК:
1. Создана директория для учебных целей `/root/learning-kubernetis`
2. Склонирован в нее репозиторий от преподавателя: https://github.com/aak74/kubernetes-for-beginners
3. Запущен PyCharm от root и открыть проект `kubernetes-for-beginners`

#### -00:31:24 - О команде cubectl
![cubectl-command_01](/12-kubernetes-02-commands/Files/cubectl-command_01.png)
* Команды слева - относятся к управлению нодами
* Команды справа - команды для управления, не относятся к управлению нод.
* Команды  врамочках - для управлению нодами в том числе

![cubeadm-command_01](/12-kubernetes-02-commands/Files/cubeadm-command_01.png)

#### -00:34:20 kubectl get

#### -00:37:25 k9s
![k9s_01](/12-kubernetes-02-commands/Files/k9s_01.png)
Выход из него: `:q`
Редактировать с помощью этой утилиты тоже можно.

#### -00:40:10 kubectl logs
#### -00:40:50 kubectl delete
#### -00:41:20 watch 'kubectl pods'
#### -00:48:15 kubectl describe
#### -00:49:40 kubectl get -o yaml / json
#### -00:53:20 kubectl logs -f -c
#### -00:55:20 watch 'kubectl get pods -l app'
#### -01:00:10 kubectl taint
#### -01:05:00 kubectl edit deployment main
#### -01:07:00 kubectl scale deployment main --replicas=2
#### -01:09:55 kubectl apply
#### -01:11:30 kubectl drain
#### -01:13:00 про taint, tolerante 
#### -01:14:40 kubectl port-forward
#### -01:21:30 kubectl get svc
#### -01:23:30 kubectl config
#### -01:24:20 kubectl --context=prod get nodes
#### -01:27:00 kubectl uncordon node01
#### -01:28:30 kubectl create deployment   -  можно использовать в ДЗ
#### -01:28:50 watch 'kubectl get pods -n default
#### -01:28:50 kubectl create deployment nginx --namespace default image=nginx
#### -01:30:20 kubectl delete deployments.apps -n default nginx
#### -01:31:00 kubeadm


-01:32:40 - рекомендация устанавливать kubrctl на локальный ПК. Устанавливать его надо под обычным пользователем.
-01:34:20 - рекомендация устанавливать `bash complition` - автодополнение команд


### 25Домашнее задание    -01:35:55

-01:37:20 - пояснение по Заданию №3. Надо сделать все наоборот. Надо изменить кол-во реплик на 5 команда `kubectl edit` или `kubectl scale`. Проверить что их стало 5 вместо двух первоначальных. Команда `kubectl get pods`

-01:38:00 - по Заданию №2. Сложное задание. Сасое интересное и исследовательское. Выполнив это задание мы будем готовы делать много других вещей.  Нужо сначала завести пользователя кубера. Поптом предоставить доступа. ИЛи. Не создавать пользователя, а создать сервис-аккаунт и для этого сервис-аккаунта предоставить какой-то набор прав с тем чтобы плзователи имели доступ. Подскахки: RBAC, ServiceAccounte, Role, RoleBinding.
- Ответ должен выгледеть так:
  - Каким образом мы создаем пользователя или Сервисеаккаунт (какие команды)
  - Продемонстрировать с помощью команд кубконфиг пользователя что он не может создать намеспейс
  - Продемонстрировать что этот пользователь другие команды не может выполнить.
- Подсказка: `kubectl create clasterrole readonlyuser`


Давайте посмотрим ваше домашнее задание.
- Вопросы по домашней работе задавайте в чате мессенджера
Slack.
- Задачи можно сдавать по частям.
- Зачёт по домашней работе проставляется после того, как приняты
все задачи.

### 26Задавайте вопросы и
пишите отзыв о лекции!
Андрей Копылов
Андрей Копылов
27
