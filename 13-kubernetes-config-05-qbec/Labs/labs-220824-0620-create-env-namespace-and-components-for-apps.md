## ЛР-220824-0620. Подготовка к выполнению ДЗ. Технология проектирования приложения. Разделение на компоненты. Проектирование сред для различных целей.

- [ЛР-220824-0620. Подготовка к выполнению ДЗ. Технология проектирования приложения. Разделение на компоненты. Проектирование сред для различных целей.](/13-kubernetes-config-05-qbec/Labs/labs-220824-0620-create-env-namespace-and-components-for-apps.md)

### Технология проектирования приложения. 

### Разделение на компоненты. 

- Компоненты это код, который представляет Kubernetes объекты. 
- Обычно в один компонент помещают все Kubernetes объекты, которые представляют собой ваше приложение.
- Часто в один компонент помещают такие объекты: `service account`, `deployment`, `service`, `config map` и другие.
- В рамках одного приложения может быть более одного компонента.
- Компоненты загружаются из jsonnet, json или yaml файлов. 
- Но только jsonnet файлы обеспечивают возможность кастомизировать объекты для различных окружений.
- Qbec поддерживает загрузку объектов из helm чартов, и использует jsonnet библиотеки для их генерации.
- Подробнее смотри в [документации](https://qbec.io/userguide/usage/authoring/).

1. Для каждой env определить:
  - в каком namespace будет работать
  - какие приложения будут развернуты
2. Начать с описания каждой env

#### Env base.

#### Env default.

#### Env stage. 
Включает в себя:
  - Deployment, состоящий из двух приложений - frontend и backend.
  - Service NodePort для подключения извне, 
  - Service EndPoint для подключения к внутренней БД
  - StatefulSet для создания внутренней БД 
  - ReplicaSet


#### Env prod
Включает в себя:
  - StatefulSet для frontend
  - StatefulSet для backend
  - Service, включающий в себя NodePort для подключения извне, EndPoint для подключения к внутренней БД
  - StatefulSet для внешней БД 
  - ReplicaSet


### Создание библиотек.

### Проектирование сред для различных целей.
Это означает что нужно для каждой среды:
- определить сервер K8s
- на том сервере определить namespace
- состав компонентов, которые буду включены в каждую среду (см. пример ниже)

### Включение и исключение компонентов для различных сред.
Данное действие выполняется в файле `qbec.yaml`

* Пример:
```yml
apiVersion: qbec.io/v1alpha1
kind: App
metadata:
  name: 20-next
spec:
  environments:
    default:
      defaultNamespace: default
      server: https://130.193.58.127:16443
    hello2:
      defaultNamespace: qbec-stage
      server: https://130.193.58.127:16443
      includes:
        - hello2
    stage:
      defaultNamespace: qbec-stage
      server: https://130.193.58.127:16443
    prod:
      defaultNamespace: qbec-prod
      server: https://130.193.58.127:16443
      excludes:
        - postgres
        - rabbitmq
  vars: {}
  # list of components to exclude by default
  excludes:
    - hello2
```

### Проектирование файлов jsonnet для генерации манифестов
#### Составные части манифестов
#### Части манифестов, передаваемые в библиотеки.
#### Написание функций для генерации манифестов
#### Изменение параметров в средах, отличных от базовой
Материал [ПАРАМЕТРЫ ВРЕМЕНИ ВЫПОЛНЕНИЯ](https://qbec.io/userguide/usage/runtime-params/)

Параметры времени выполнения — это значения, которые различаются в разных средах, изменяются со временем или представляют собой секреты, которые нельзя случайно раскрывать.

Такие свойства, как реплики развертывания для каждой среды, конечные точки на уровне кластера и т. д., обычно известны заранее и должны быть проверены в исходном коде.

Некоторые параметры невозможно проверить в исходном коде. К ним относятся теги для образов, созданных сборкой CI, значения которых впоследствии должны использоваться в той же сборке для развертывания, секреты, специфичные для среды, и т. д.

qbec предоставляет следующие возможности для параметров времени выполнения.

он предоставляет внешнюю переменную qbec.io/env, содержащую имя среды, используемой для команды. Это позволяет вам параметризовать значения на основе имени среды. Например, вы можете использовать это имя в качестве ключа в карте переменных с ключами по имени среды.
qbec.io/envPropertiesон предоставляет внешнему набору переменных свойства, определенные qbec.yamlдля среды. Это хорошее место для хранения статических свойств среды, таких как имя кластера, внешние конечные точки, связанные с кластером и т. д.
он позволяет вам объявлять внешние переменные jsonnet qbec.yaml со значениями по умолчанию. Значения внешних переменных можно указать в командной строке. Значения по умолчанию используются, когда объявленные переменные не установлены. Этот механизм позволяет вам разрабатывать компоненты локально, не указывая переменные в командной строке для каждого вызова, и по-прежнему устанавливать их явно, когда вы фактически применяете объекты к кластеру.
он позволяет вам объявлять переменные верхнего уровня jsonnet qbec.yamlи связывать их с компонентами, которым они должны быть переданы. В этом случае вы устанавливаете значения по умолчанию для этих переменных в самом коде jsonnet.

[Учебник jsonnet](https://jsonnet.org/learning/tutorial.html#parameterize-entire-config) подробно объясняет внешние переменные и переменные верхнего уровня, а также плюсы и минусы каждой из них.

Давайте рассмотрим каждый из них по очереди.

* [Использование qbec.io/env](https://qbec.io/userguide/usage/runtime-params/#using-qbecioenv)
```
local env = std.extVar('qbec.io/env'); // get the value of the environment

// define baseline parameters
local baseParams = {
    components: {
        service1: {
            replicas: 1,
        },
    },
};

// define parameters per environment
local paramsByEnv = {

    _: baseParams, // the baseline environment used by qbec for some commands

    dev: baseParams {
        components+: {
            service1+: {
                replicas: 2,
            },
        },
    },

    prod: baseParams {
        components+: {
            service1+: {
                replicas: 3,
            },
        },
    },
};

// return value for correct environment
if std.objectHas(paramsByEnv, env) then paramsByEnv[env] else error 'environment ' + env ' not defined in ' + std.thisFile
 
```
* [Использование внешних переменных jsonnet](https://qbec.io/userguide/usage/runtime-params/#using-jsonnet-external-variables)

```
spec:
    vars:
      external:
        - name: service1_image_tag
          default: latest

        - name: service1_secret
          default: changeme # fake value
          secret: true # qbec debug logs will not print this value in cleartext
```
атем вы можете использовать их в своих компонентах или объекте конфигурации параметров времени выполнения, например:

    local imageTag = std.extVar('service1_image_tag');
    
и укажите реальные значения в командной строке qbec:

    export service1_secret=XXX
    qbec apply dev --vm:ext-str service1_image_tag=1.0.3 --vm:ext-str service1_secret

Обратите внимание, что мы явно устанавливаем для тега изображения значение 1.0.3, но не указываем значение секрета в командной строке. Это заставляет qbec установить секретное значение из переменной среды с тем же именем. Это предпочтительный метод передачи секретов.
